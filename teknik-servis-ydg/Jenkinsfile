pipeline {
    agent any

    triggers {
        githubPush()
    }

    options {
        timestamps()
        disableConcurrentBuilds()
        skipDefaultCheckout(true)
    }

    environment {
        DOCKER_IMAGE       = "teknik-servis-image"
        DOCKER_CONTAINER   = "teknik-servis-final-container"
        DOCKER_NETWORK     = "teknik-servis-final-net"

        SELENIUM_CONTAINER = "selenium-chrome-final"
        SELENIUM_PORT      = "4445"

        APP_HOST_PORT      = "8082"
        APP_CONTAINER_PORT = "8082"
        BASE_URL           = "http://localhost:8082"

        SELENIUM_HEADLESS  = "true"
    }

    stages {

        stage('0- Debug Tools') {
            steps {
                bat '''
                echo ==== DEBUG TOOLS ====
                where git
                git --version
                where java
                java -version
                docker --version
                echo =====================
                '''
            }
        }

        stage('1- Checkout from GitHub') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    userRemoteConfigs: [[
                        url: 'https://github.com/muhammetemirdogan/teknik-servis-ydg-final.git',
                        credentialsId: 'github-ydg-token'
                    ]],
                    doGenerateSubmoduleConfigurations: false,
                    extensions: [
                        [$class: 'CleanBeforeCheckout']
                    ]
                ])

                bat '''
                echo ==== WORKSPACE CONTENT ====
                dir
                echo ==========================
                '''
            }
        }

        stage('2- Build (skip tests)') {
            steps {
                dir('teknik-servis-ydg') {
                    bat 'call mvnw -B -DskipTests clean package'
                }
            }
        }

        stage('3- Unit Tests (*UnitTest.java)') {
            steps {
                dir('teknik-servis-ydg') {
                    bat 'call mvnw -B -DskipUnitTests=false -Dsurefire.reportsDirectory=target/surefire-reports-unit test'
                }
            }
        }

        stage('4- Integration Tests (*IT.java)') {
            steps {
                dir('teknik-servis-ydg') {
                    bat 'call mvnw -B -DskipUnitTests=true -Dfailsafe.reportsDirectory=target/failsafe-reports-it verify'
                }
            }
        }

        stage('5- Docker Build & Run App') {
            steps {
                dir('teknik-servis-ydg') {
                    bat """
                    setlocal EnableExtensions
                    echo ==== DOCKER PRE-CLEAN ====

                    docker rm -f %DOCKER_CONTAINER% 1>NUL 2>NUL
                    docker rm -f %SELENIUM_CONTAINER% 1>NUL 2>NUL

                    REM Host port %APP_HOST_PORT% kullanan container varsa sil
                    for /F "tokens=1" %%i in ('docker ps -a --format "{{.ID}} {{.Ports}}" ^| findstr /C:":%APP_HOST_PORT%->"') do (
                      echo Removing container using host port %APP_HOST_PORT%: %%i
                      docker rm -f %%i 1>NUL 2>NUL
                    )

                    docker network rm %DOCKER_NETWORK% 1>NUL 2>NUL
                    docker network create %DOCKER_NETWORK% 1>NUL || exit /b 1

                    if not exist Dockerfile (
                      echo Dockerfile bulunamadi! Bulundugun klasor:
                      cd
                      dir
                      exit /b 1
                    )

                    echo ==== DOCKER BUILD ====
                    docker build -t %DOCKER_IMAGE% . || exit /b 1

                    echo ==== DOCKER RUN APP ====
                    docker run -d --rm -p %APP_HOST_PORT%:%APP_CONTAINER_PORT% --name %DOCKER_CONTAINER% --network %DOCKER_NETWORK% %DOCKER_IMAGE% || exit /b 1

                    endlocal
                    """
                }

                // ✅ BAT içine gömmüyoruz, doğrudan powershell step:
                powershell """
                  \$ErrorActionPreference = 'SilentlyContinue'
                  \$urls = @(
                    '${env.BASE_URL}/actuator/health',
                    '${env.BASE_URL}/api/servis-kayitlari'
                  )

                  for(\$i=1; \$i -le 40; \$i++){
                    foreach(\$u in \$urls){
                      try{
                        \$r = Invoke-WebRequest -UseBasicParsing -Uri \$u -TimeoutSec 2
                        if(\$r.StatusCode -eq 200){
                          Write-Host ('HEALTH OK: ' + \$u)
                          exit 0
                        }
                      } catch {}
                    }
                    Start-Sleep -Seconds 2
                  }

                  throw 'Uygulama ayaga kalkmadi: ${env.BASE_URL}'
                """
            }
        }

        stage('6- Start Selenium Container (4445)') {
            steps {
                bat """
                docker rm -f %SELENIUM_CONTAINER% 1>NUL 2>NUL
                docker run -d --rm --name %SELENIUM_CONTAINER% --network %DOCKER_NETWORK% -p %SELENIUM_PORT%:4444 selenium/standalone-chrome:latest
                """

                powershell """
                  \$ErrorActionPreference='SilentlyContinue'
                  for(\$i=1; \$i -le 30; \$i++){
                    try{
                      \$r = Invoke-WebRequest -UseBasicParsing -Uri 'http://localhost:${env.SELENIUM_PORT}/status' -TimeoutSec 2
                      if(\$r.StatusCode -eq 200){ Write-Host 'SELENIUM OK'; exit 0 }
                    } catch {}
                    Start-Sleep -Seconds 2
                  }
                  throw 'Selenium ayaga kalkmadi'
                """
            }
        }

        stage('6.1- Selenium Senaryo 1') {
            steps {
                dir('teknik-servis-ydg') {
                    bat 'call mvnw -B -Dtest=com.example.teknikservis.selenium.Senaryo1SeleniumTest -Dsurefire.reportsDirectory=target/surefire-reports-e2e-s1 -DbaseUrl=http://%DOCKER_CONTAINER%:%APP_CONTAINER_PORT% -DseleniumRemoteUrl=http://localhost:%SELENIUM_PORT%/wd/hub -Dheadless=%SELENIUM_HEADLESS% test'
                }
            }
        }

        stage('6.2- Selenium Senaryo 2') {
            steps {
                dir('teknik-servis-ydg') {
                    bat 'call mvnw -B -Dtest=com.example.teknikservis.selenium.Senaryo2SeleniumTest -Dsurefire.reportsDirectory=target/surefire-reports-e2e-s2 -DbaseUrl=http://%DOCKER_CONTAINER%:%APP_CONTAINER_PORT% -DseleniumRemoteUrl=http://localhost:%SELENIUM_PORT%/wd/hub -Dheadless=%SELENIUM_HEADLESS% test'
                }
            }
        }

        stage('6.3- Selenium Senaryo 3') {
            steps {
                dir('teknik-servis-ydg') {
                    bat 'call mvnw -B -Dtest=com.example.teknikservis.selenium.Senaryo3SeleniumTest -Dsurefire.reportsDirectory=target/surefire-reports-e2e-s3 -DbaseUrl=http://%DOCKER_CONTAINER%:%APP_CONTAINER_PORT% -DseleniumRemoteUrl=http://localhost:%SELENIUM_PORT%/wd/hub -Dheadless=%SELENIUM_HEADLESS% test'
                }
            }
        }

        stage('6.4- Selenium Senaryo 4') {
            steps {
                dir('teknik-servis-ydg') {
                    bat 'call mvnw -B -Dtest=com.example.teknikservis.selenium.Senaryo4SeleniumTest -Dsurefire.reportsDirectory=target/surefire-reports-e2e-s4 -DbaseUrl=http://%DOCKER_CONTAINER%:%APP_CONTAINER_PORT% -DseleniumRemoteUrl=http://localhost:%SELENIUM_PORT%/wd/hub -Dheadless=%SELENIUM_HEADLESS% test'
                }
            }
        }

        stage('6.5- Selenium Senaryo 5') {
            steps {
                dir('teknik-servis-ydg') {
                    bat 'call mvnw -B -Dtest=com.example.teknikservis.selenium.Senaryo5SeleniumTest -Dsurefire.reportsDirectory=target/surefire-reports-e2e-s5 -DbaseUrl=http://%DOCKER_CONTAINER%:%APP_CONTAINER_PORT% -DseleniumRemoteUrl=http://localhost:%SELENIUM_PORT%/wd/hub -Dheadless=%SELENIUM_HEADLESS% test'
                }
            }
        }

        stage('6.6- Selenium Senaryo 6') {
            steps {
                dir('teknik-servis-ydg') {
                    bat 'call mvnw -B -Dtest=com.example.teknikservis.selenium.Senaryo6SeleniumTest -Dsurefire.reportsDirectory=target/surefire-reports-e2e-s6 -DbaseUrl=http://%DOCKER_CONTAINER%:%APP_CONTAINER_PORT% -DseleniumRemoteUrl=http://localhost:%SELENIUM_PORT%/wd/hub -Dheadless=%SELENIUM_HEADLESS% test'
                }
            }
        }

        stage('6.7- Selenium Senaryo 7') {
            steps {
                dir('teknik-servis-ydg') {
                    bat 'call mvnw -B -Dtest=com.example.teknikservis.selenium.Senaryo7SeleniumTest -Dsurefire.reportsDirectory=target/surefire-reports-e2e-s7 -DbaseUrl=http://%DOCKER_CONTAINER%:%APP_CONTAINER_PORT% -DseleniumRemoteUrl=http://localhost:%SELENIUM_PORT%/wd/hub -Dheadless=%SELENIUM_HEADLESS% test'
                }
            }
        }

        stage('6.8- Selenium Senaryo 8') {
            steps {
                dir('teknik-servis-ydg') {
                    bat 'call mvnw -B -Dtest=com.example.teknikservis.selenium.Senaryo8SeleniumTest -Dsurefire.reportsDirectory=target/surefire-reports-e2e-s8 -DbaseUrl=http://%DOCKER_CONTAINER%:%APP_CONTAINER_PORT% -DseleniumRemoteUrl=http://localhost:%SELENIUM_PORT%/wd/hub -Dheadless=%SELENIUM_HEADLESS% test'
                }
            }
        }

        stage('6.9- Selenium Senaryo 9') {
            steps {
                dir('teknik-servis-ydg') {
                    bat 'call mvnw -B -Dtest=com.example.teknikservis.selenium.Senaryo9SeleniumTest -Dsurefire.reportsDirectory=target/surefire-reports-e2e-s9 -DbaseUrl=http://%DOCKER_CONTAINER%:%APP_CONTAINER_PORT% -DseleniumRemoteUrl=http://localhost:%SELENIUM_PORT%/wd/hub -Dheadless=%SELENIUM_HEADLESS% test'
                }
            }
        }

        stage('6.10- Selenium Senaryo 10') {
            steps {
                dir('teknik-servis-ydg') {
                    bat 'call mvnw -B -Dtest=com.example.teknikservis.selenium.Senaryo10SeleniumTest -Dsurefire.reportsDirectory=target/surefire-reports-e2e-s10 -DbaseUrl=http://%DOCKER_CONTAINER%:%APP_CONTAINER_PORT% -DseleniumRemoteUrl=http://localhost:%SELENIUM_PORT%/wd/hub -Dheadless=%SELENIUM_HEADLESS% test'
                }
            }
        }
    }

    post {
        always {
            junit testResults: 'teknik-servis-ydg/target/surefire-reports-*/TEST-*.xml,teknik-servis-ydg/target/failsafe-reports*/TEST-*.xml,teknik-servis-ydg/target/failsafe-reports*/*.xml',
                  allowEmptyResults: true

            archiveArtifacts artifacts: 'teknik-servis-ydg/target/surefire-reports-*/**/*.xml,teknik-servis-ydg/target/failsafe-reports*/**/*.xml',
                             allowEmptyArchive: true
        }

        failure {
            bat '''
            echo ---- FAIL DEBUG: docker ps ----
            docker ps -a
            echo ---- FAIL DEBUG: docker logs (app) ----
            docker logs %DOCKER_CONTAINER% 2>NUL || echo No app container logs
            echo ---- FAIL DEBUG: docker logs (selenium) ----
            docker logs %SELENIUM_CONTAINER% 2>NUL || echo No selenium container logs
            exit /b 0
            '''
        }

        cleanup {
            bat 'docker rm -f %SELENIUM_CONTAINER% 1>NUL 2>NUL || exit /b 0'
            bat 'docker rm -f %DOCKER_CONTAINER% 1>NUL 2>NUL || exit /b 0'
            bat 'docker network rm %DOCKER_NETWORK% 1>NUL 2>NUL || exit /b 0'
        }
    }
}
